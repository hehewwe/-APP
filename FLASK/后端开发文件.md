# 项目后端服务 (`myflask3.py`) 技术说明文档

---

## 1. 项目概述

本项目基于 **Flask** 框架，提供“诈骗信息识别”App 的后端服务。相较于早期版本，此版本引入了 **MySQL 数据库持久化**、**用户角色管理** 和 **强大的后台管理功能**。

- **技术栈**：Python, Flask, Flask-CORS, Flask-SQLAlchemy, PyMySQL
- **服务端口**：5000
- **启动命令**：`python myflask3.py`

---

## 2. 核心设计逻辑

### 2.1 数据库持久化

- **数据库**：使用 **MySQL** 存储所有核心数据。
- **ORM**：通过 **Flask-SQLAlchemy** 实现对象关系映射，将 Python 类与数据库表对应，简化数据库操作。
- **核心数据模型**：
    - `User`: 存储用户信息（ID, 用户名, 密码, 角色）。
    - `SmsRecord`: 存储用户提交的短信分析记录，包含案件编号、文本、分析结果等，并与 `User` 表关联。
    - `CaseSerial`: 案件编号生成器表，确保生成的案件编号唯一且自增。

### 2.2 用户认证与会话管理

- **会话管理 (Session)**：用户登录成功后，`session` 中会记录 `username` 和 `role`（用户角色），作为后续接口调用的身份和权限凭据。
- **角色权限 (RBAC)**：用户分为 `user` 和 `admin` 两种角色。部分后台管理接口通过 `@admin_required` 装饰器进行保护，仅 `admin` 角色的用户可以访问。

### 2.3 文本分析与案件编号

- **文本分析**：核心分析逻辑通过内置的关键词匹配规则 (`mock_model`) 实现。在生产环境中，该部分可以替换为对外部专业模型服务的 API 调用。
- **案件编号生成**：`gen_case_no` 函数通过数据库事务实现了一个线程/进程安全的编号发号器，能够根据诈骗类型（如'a', 'b', 'c'等）生成格式为 `类别字母 + 五位数字` 的唯一案件编号（例如 `a00001`）。

---

## 3. API 接口说明

### 3.1 公共接口

#### a) 用户注册

- **路径**：`/register`
- **方法**：POST
- **请求体** (JSON):
  ```json
  {
    "username": "新用户名",
    "password": "新用户密码"
  }
  ```
- **返回示例**:
  - 成功 (HTTP 200): `{"code": 200, "msg": "注册成功"}`
  - 失败 (HTTP 400/500): `{"code": 400, "msg": "该账号已存在"}` 或 `{"code": 500, "msg": "注册失败"}`

#### b) 用户登录

- **路径**：`/try/login`
- **方法**：POST
- **请求体** (JSON):
  ```json
  {
    "username": "用户的手机号",
    "password": "用户的密码"
  }
  ```
- **返回示例**:
  - 成功 (HTTP 200):
    ```json
    {
      "code": 200,
      "msg": "登录成功",
      "data": {
        "username": "登录的用户名",
        "role": "user" 
      }
    }
    ```
  - 失败 (HTTP 401): `{"code": 401, "msg": "账号或密码输入错误"}`

#### c) 检查登录状态

- **路径**：`/session`
- **方法**：GET
- **请求体**：无
- **返回示例**:
  - 已登录 (HTTP 200): `{"username": "当前用户名", "role": "user"}`
  - 未登录 (HTTP 401): `{"code": 401, "msg": "出错了，没登录"}`

#### d) 退出登录

- **路径**：`/try/logout`
- **方法**：GET
- **请求体**：无
- **返回示例** (HTTP 200): `{"code": 200, "msg": "成功退出登录!"}`

### 3.2 核心功能接口

#### a) 文本分析接口（需登录）

- **路径**：`/analyze_text`
- **方法**：POST
- **请求体** (JSON):
  ```json
  {
    "短信文本": "需要分析的文本内容"
  }
  ```
- **核心流程**:
  1. 检查用户登录状态。
  2. 调用模型分析文本。
  3. 根据分析结果生成唯一的案件编号。
  4. 将分析结果（包括案件编号、文本、是否诈骗、诈骗类型、详情）存入 `sms_record` 数据库表。
- **返回示例** (HTTP 200):
  ```json
  {
    "编号": "c00001",
    "诈骗类别": "冒充电商物流客服类",
    "诈骗信息": "经分析，该信息疑似“冒充电商物流客服类”类型诈骗..."
  }
  ```

---

## 4. 后台管理 API (Admin)

以下所有接口都需要管理员 (`admin`) 权限。

### 4.1 数据查询与管理

#### a) 通用数据查询

- **路径**：`/admin/data/<table_name>`
- **方法**：GET
- **路径参数**: `<table_name>` 可以是 `user`, `sms_record`, `case_serial`。
- **功能**：获取指定表的全部数据。
- **返回示例** (HTTP 200): `{"code": 200, "data": [...]}`

#### b) 通用数据删除

- **路径**：`/admin/data/<table_name>/<item_id>`
- **方法**：DELETE
- **路径参数**: `<table_name>` 和 `<item_id>`（要删除的条目ID）。
- **功能**：删除指定表中的特定条目。如果删除用户，会级联删除该用户的所有短信记录。
- **返回示例** (HTTP 200): `{"code": 200, "msg": "成功删除..."}`

#### c) 增强版短信记录查询

- **路径**：`/admin/sms_records`
- **方法**：GET
- **查询参数**:
  - `page`: 页码 (默认 1)
  - `per_page`: 每页数量 (默认 10)
  - `fraud_type`: 按诈骗类型筛选
  - `is_fraud`: 按是否诈骗筛选 ('true' 或 'false')
  - `search_keyword`: 在短信内容和用户名中进行模糊搜索
- **功能**：提供带筛选和分页的高级查询功能。
- **返回示例** (HTTP 200):
  ```json
  {
    "current_page": 1,
    "data": [...],
    "pages": 5,
    "total": 50
  }
  ```

### 4.2 统计与重置

#### a) 获取统计数据

- **路径**：`/admin/stats`
- **方法**：GET
- **功能**：获取关键业务统计数据。
- **返回示例** (HTTP 200):
  ```json
  {
    "today_new_records": 15,
    "total_fraud_records": 120,
    "top_fraud_type": {
      "type": "刷单返利类",
      "percentage": 45.5
    }
  }
  ```

#### b) 一键重置数据

- **路径**：`/admin/reset_data`
- **方法**：POST
- **功能**：**【危险操作】** 清空所有 `sms_record` 记录，并重置所有 `case_serial` 编号计数器为 1。
- **返回示例** (HTTP 200): `{"code": 200, "msg": "所有记录已清空，案件编号已重置"}`

#### c) 重置单个分类计数器

- **路径**：`/admin/reset_category/<category_pk>`
- **方法**：POST
- **路径参数**: `<category_pk>` 是要重置的类别字母（例如 'a', 'b'）。
- **功能**：将指定类别的案件编号计数器重置为 1。
- **返回示例** (HTTP 200): `{"code": 200, "msg": "类别 'a' 的计数器已成功归1"}`

